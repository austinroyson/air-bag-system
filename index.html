#include <ESP8266WiFi.h>
#include <FirebaseESP8266.h>
#include <SoftwareSerial.h>
#include <addons/TokenHelper.h>

// Pin Definitions
#define HC12_RX D2  // GPIO4
#define HC12_TX D1  // GPIO5
#define BUZZER_PIN D5  // GPIO14
#define STATUS_LED D4  // GPIO2

// WiFi Credentials
#define WIFI_SSID "vivo T4 lite"  // Replace with your WiFi name
#define WIFI_PASSWORD "********"  // Replace with your WiFi password

// Firebase Credentials
#define FIREBASE_HOST "airbagsystemlive-default-rtdb.firebaseio.com"
#define FIREBASE_AUTH "aXdufJj388zwrYHzlktz7kh2bppsPkhXDNZJXpQW"

// Objects
SoftwareSerial hc12(HC12_RX, HC12_TX);
FirebaseData firebaseData;
FirebaseAuth auth;
FirebaseConfig config;

// Variables
bool alertActive = false;
unsigned long lastAlertTime = 0;
int alertCount = 0;
int surfaceUpdateCount = 0;

void setup() {
  Serial.begin(9600);  // Changed to 9600 baud
  hc12.begin(9600);

  // Pin modes
  pinMode(BUZZER_PIN, OUTPUT);
  pinMode(STATUS_LED, OUTPUT);
  digitalWrite(BUZZER_PIN, LOW);
  digitalWrite(STATUS_LED, LOW);

  // Connect to WiFi
  Serial.println(F("\nConnecting to WiFi..."));
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);

  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 20) {
    delay(500);
    Serial.print(".");
    digitalWrite(STATUS_LED, !digitalRead(STATUS_LED));
    attempts++;
  }

  if (WiFi.status() == WL_CONNECTED) {
    Serial.println(F("\nWiFi Connected!"));
    Serial.print(F("IP Address: "));
    Serial.println(WiFi.localIP());
    digitalWrite(STATUS_LED, HIGH);
  } else {
    Serial.println(F("\nWiFi Connection Failed!"));
    // Continue anyway to receive LoRa data
  }

  // Configure Firebase
  config.host = FIREBASE_HOST;
  config.signer.tokens.legacy_token = FIREBASE_AUTH;

  // Initialize Firebase
  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);
  firebaseData.setBSSLBufferSize(1024, 1024);
  firebaseData.setResponseSize(1024);

  Serial.println(F("External Unit Ready - Listening for alerts..."));
  playStartupTone();
}

void loop() {
  // Check for incoming LoRa data
  if (hc12.available()) {
    String receivedData = hc12.readStringUntil('\n');
    receivedData.trim();

    Serial.print(F("Received: "));
    Serial.println(receivedData);

    // Check if it's an alert message
    if (receivedData.startsWith("EMERGENCY!")) {
      handleEmergencyAlert(receivedData);
    } else if (receivedData.startsWith("SURFACE")) {
      handleSurfaceUpdate(receivedData);
    }
  }

  // If alert is active, keep buzzer going
  if (alertActive) {
    playAlertSound();

    // Auto-stop alert after 5 minutes
    if (millis() - lastAlertTime > 300000) {
      alertActive = false;
      digitalWrite(BUZZER_PIN, LOW);
      Serial.println(F("Alert timeout - stopping buzzer"));
    }
  }

  delay(100);
}

void handleEmergencyAlert(String alertData) {
  alertActive = true;
  lastAlertTime = millis();
  alertCount++;

  Serial.println(F("!!! DROWNING ALERT RECEIVED !!!"));

  float latitude = 0;
  float longitude = 0;
  float pressure = 0;
  long timestamp = 0;

  // Extract values
  int latIndex = alertData.indexOf("LAT:");
  int lonIndex = alertData.indexOf("LON:");
  int pressureIndex = alertData.indexOf("PRESSURE:");
  int timeIndex = alertData.indexOf("TIME:");

  if (latIndex != -1) {
    latitude = alertData.substring(latIndex + 4, lonIndex).toFloat();
  }
  if (lonIndex != -1) {
    longitude = alertData.substring(lonIndex + 4, pressureIndex).toFloat();
  }
  if (pressureIndex != -1) {
    pressure = alertData.substring(pressureIndex + 9, timeIndex).toFloat();
  }
  if (timeIndex != -1) {
    timestamp = alertData.substring(timeIndex + 5).toInt();
  }

  Serial.print(F("Location: "));
  Serial.print(latitude, 6);
  Serial.print(F(", "));
  Serial.println(longitude, 6);
  Serial.print(F("Pressure: "));
  Serial.print(pressure);
  Serial.println(F(" hPa"));

  // Send to Firebase
  if (WiFi.status() == WL_CONNECTED) {
    sendEmergencyToFirebase(latitude, longitude, pressure, timestamp);
  } else {
    Serial.println(F("WiFi not connected - cannot send to Firebase"));
  }

  // Play alert sound
  playAlertSound();
}

void handleSurfaceUpdate(String surfaceData) {
  surfaceUpdateCount++;

  float latitude = 0;
  float longitude = 0;
  float pressure = 0;
  long timestamp = 0;

  // Extract values
  int latIndex = surfaceData.indexOf("LAT:");
  int lonIndex = surfaceData.indexOf("LON:");
  int pressureIndex = surfaceData.indexOf("PRESSURE:");
  int timeIndex = surfaceData.indexOf("TIME:");

  if (latIndex != -1) {
    latitude = surfaceData.substring(latIndex + 4, lonIndex).toFloat();
  }
  if (lonIndex != -1) {
    longitude = surfaceData.substring(lonIndex + 4, pressureIndex).toFloat();
  }
  if (pressureIndex != -1) {
    pressure = surfaceData.substring(pressureIndex + 9, timeIndex).toFloat();
  }
  if (timeIndex != -1) {
    timestamp = surfaceData.substring(timeIndex + 5).toInt();
  }

  Serial.print(F("Surface Location: "));
  Serial.print(latitude, 6);
  Serial.print(F(", "));
  Serial.println(longitude, 6);
  Serial.print(F("Pressure: "));
  Serial.print(pressure);
  Serial.println(F(" hPa"));

  // Send to Firebase
  if (WiFi.status() == WL_CONNECTED) {
    sendSurfaceToFirebase(latitude, longitude, pressure, timestamp);
  } else {
    Serial.println(F("WiFi not connected - cannot send surface update to Firebase"));
  }
}

void sendEmergencyToFirebase(float lat, float lon, float pressure, long timestamp) {
  // Create a unique emergency ID based on timestamp
  String emergencyPath = "/emergencies/emergency_" + String(timestamp);

  // Prepare JSON data
  FirebaseJson json;
  json.set("latitude", lat);
  json.set("longitude", lon);
  json.set("pressure", pressure);
  json.set("timestamp", timestamp);
  json.set("alertCount", alertCount);
  json.set("status", "ACTIVE");
  json.set("receivedAt", String(millis() / 1000));
  json.set("type", "EMERGENCY");

  // Send to Firebase (list of emergencies)
  Serial.print(F("Sending to Firebase: "));
  Serial.println(emergencyPath);

  if (Firebase.setJSON(firebaseData, emergencyPath, json)) {
    Serial.println(F("Firebase update successful!"));

    // Also update latest emergency (for dashboard real-time)
    Firebase.setJSON(firebaseData, "/latestEmergency", json);

    // Blink LED to confirm
    for (int i = 0; i < 3; i++) {
      digitalWrite(STATUS_LED, LOW);
      delay(100);
      digitalWrite(STATUS_LED, HIGH);
      delay(100);
    }
  } else {
    Serial.print(F("Firebase update failed: "));
    Serial.println(firebaseData.errorReason());
  }
}

void sendSurfaceToFirebase(float lat, float lon, float pressure, long timestamp) {
  String trackingPath = "/tracking/tracking_" + String(timestamp);

  FirebaseJson json;
  json.set("latitude", lat);
  json.set("longitude", lon);
  json.set("pressure", pressure);
  json.set("timestamp", timestamp);
  json.set("status", "SURFACE");
  json.set("type", "TRACKING");

  // Send to Firebase (list of tracking updates)
  if (Firebase.setJSON(firebaseData, trackingPath, json)) {
    Serial.println(F("Surface tracking update successful!"));
    // Also update latest location
    Firebase.setJSON(firebaseData, "/latestLocation", json);
  } else {
    Serial.print(F("Surface tracking update failed: "));
    Serial.println(firebaseData.errorReason());
  }
}

void playAlertSound() {
  // Create urgent siren pattern
  for (int i = 0; i < 3; i++) {
    // Rising tone
    for (int freq = 800; freq < 2000; freq += 100) {
      tone(BUZZER_PIN, freq, 50);
      delay(50);
    }
    // Falling tone
    for (int freq = 2000; freq > 800; freq -= 100) {
      tone(BUZZER_PIN, freq, 50);
      delay(50);
    }
  }
  noTone(BUZZER_PIN);
  delay(500);
}

void playStartupTone() {
  // Play startup confirmation
  tone(BUZZER_PIN, 1000, 200);
  delay(300);
  tone(BUZZER_PIN, 1500, 200);
  delay(300);
  noTone(BUZZER_PIN);
}
